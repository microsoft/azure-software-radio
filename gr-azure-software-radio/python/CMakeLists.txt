# Copyright 2011 Free Software Foundation, Inc.
#
# This file was generated by gr_modtool, a tool from the GNU Radio framework
# This file is a part of gr-azure_software_radio
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
function(GR_PYTHON_REQUIREMENTS_CHECK)
    CMAKE_PARSE_ARGUMENTS(GR_PYTHON_REQUIREMENTS_CHECK "" "REQUIREMENTS" "" ${ARGN})

    file(STRINGS ${GR_PYTHON_REQUIREMENTS_CHECK_REQUIREMENTS} requirements)
    find_package(Python3 COMPONENTS Interpreter)

    foreach(requirement ${requirements})
        execute_process(
            COMMAND ${Python3_EXECUTABLE} -c "import pkg_resources; pkg_resources.require('${requirement}')"
            OUTPUT_QUIET ERROR_QUIET
            RESULT_VARIABLE return_code
        )
        if( ${return_code} EQUAL 0 )
            message(STATUS "Python checking for ${requirement} - found")
        else()
            message(STATUS "Python checking for ${requirement} - not found")
            message(FATAL_ERROR "Detected missing Python dependencies - have you run 'pip install -r' on the python/requirements.txt file?")
        endif()
    endforeach()
endfunction(GR_PYTHON_REQUIREMENTS_CHECK)


########################################################################
# Include python install macros
########################################################################
include(GrPython)
if(NOT PYTHONINTERP_FOUND)
    return()
endif()

add_subdirectory(bindings)


########################################################################
# Install python sources
########################################################################
GR_PYTHON_INSTALL(
    FILES
    __init__.py
    blob_sink.py
    blob_source.py
    blob_qa_common.py
    blob_common.py DESTINATION ${GR_PYTHON_DIR}/azure_software_radio
)
########################################################################
GR_PYTHON_INSTALL(
    FILES
    keyvault/__init__.py
    keyvault/keyvault.py DESTINATION ${GR_PYTHON_DIR}/azure_software_radio/keyvault
)

GR_PYTHON_INSTALL(
    FILES
    default_credentials/__init__.py
    default_credentials/default_credentials.py DESTINATION ${GR_PYTHON_DIR}/azure_software_radio/default_credentials
)

########################################################################
# Handle the unit tests
########################################################################
include(GrTest)

set(GR_TEST_TARGET_DEPS gnuradio-azure_software_radio)
GR_ADD_TEST(qa_blob_sink ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/qa_blob_sink.py)
GR_ADD_TEST(qa_difi_blocks_cpp ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/qa_difi_blocks_cpp.py)
GR_ADD_TEST(qa_blob_source ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/qa_blob_source.py)
